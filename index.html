<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gest√£o de Reservas</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .booking-section {
      width: 90%;
      max-width: 1000px;
      background-color: rgba(255, 255, 255, 0.6);
      margin: 100px auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      font-family: 'Barlow Condensed', sans-serif;
      color: #4A2E1D;
    }
    form label {
      display: inline-block;
      margin: 10px;
      font-weight: 600;
      font-size: 18px;
    }
    form select, form input[type="text"], form input[type="date"] {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: 'Noto Sans', sans-serif;
    }
    form button {
      background-color: rgba(0, 0, 0, 0.5);
      color: #ffffff;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 18px;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s ease;
    }
    form button:hover {
      background-color: #ede0c4;
      color: rgb(30, 30, 30);
    }
    table th, table td {
      border-top: none;
      font-family: 'Noto Sans', sans-serif;
      font-size: 14px;
      position: relative;
      padding: 2px;
      text-align: center;
    }
    table td::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 1px;
      background-color: #cdcdcd; /* ‚Üê horizontal line color */
    }


    th {
      background-color: #4A2E1D;
      color: white;
    }
    td.booked {
      background-color: #c86c66;
      color: white;
      font-weight: bold;
    }
    td.Intervalo, th.break {
      background-color: #d3d3d3;
      color: #666;
      font-style: italic;
      min-width: 100px;
    }
    .booking-wrapper {
      position: relative;
      overflow-x: auto;
      min-height: 300px;
    }

    #bookingTable {
      border-collapse: collapse;
      border-spacing: 0;
      width: 100%;
    }

    .current-time-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: red;
      z-index: 10;
      pointer-events: none;
    }

    .modal.hidden { display: none; }
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal-card {
      background: #fff; border-radius: 12px; padding: 16px; width: 340px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2); color:#4A2E1D; font-family:'Noto Sans',sans-serif;
    }
    .modal-card h3 { margin-top:0; font-family:'Barlow Condensed',sans-serif; }
    .modal-card label { display:block; margin:10px 0 6px; font-weight:600; }
    .modal-card input { width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .modal-actions .secondary { background:#eee; color:#333; }
    .modal-actions .danger { background:#c86c66; color:#fff; }
    .modal-actions button {
      background: rgba(0,0,0,.6); color:#fff; border:none; padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .modal-actions button:hover { opacity:.9; }



  </style>
</head>
<body>
  <div id="editModal" class="modal hidden">
    <div class="modal-card">
      <h3>Editar reserva <span id="editWhen"></span></h3>

      <label>Nome
        <input type="text" id="editName">
      </label>

      <label>N¬∫ pessoas
        <input type="number" id="editPeople" min="1">
      </label>

      <label>Telefone
        <input type="text" id="editPhone">
      </label>

      <label>Coment√°rios
        <input type="text" id="editComments">
      </label>

      <div class="modal-actions">
        <button id="editSaveBtn">Guardar</button>
        <button id="editCancelBtn" class="secondary">Cancelar</button>
        <button id="editDeleteBtn" class="danger">Remover</button>
      </div>
    </div>
  </div>

  <div class="booking-section">
    <h1>Gest√£o de Reservas</h1>
    <form id="bookingForm">
      <label> Data:
        <input type="date" id="dateInput" required />
      </label>
      <label> Mesa:
        <select id="tableInput"></select>
      </label>
      <label> In√≠cio:
        <select id="timeInput"></select>
      </label>
      <label> Fim:
        <select id="endTimeInput"></select>
      </label>
      <label> Nome:
        <input type="text" id="nameInput" required />
      </label>
      <label> N¬∫ pessoas:
        <input type="number" id="peopleInput" min="1" />
      </label>
      <label> Telefone üìû
        <input type="number" id="phoneNumber"  />
      </label>
      <label> Coment√°rios
        <input type="text" id="comments"  />
      </label>
      <br>
      <button type="submit">Adicionar Reserva</button>
    </form>
    <h2>Reservas do Dia</h2>
    <div class="booking-wrapper">
      <div id="timeLine" class="current-time-line"></div>
      <table id="bookingTable">
        <thead>
          <tr>
            <th>Mesa / Hora</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const apiUrl = 'https://reservas.restaurante-patusco.workers.dev';

    const timeSlots = [];
    function pushSlot(hour, minute) {
      timeSlots.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
    }
    for (let hour = 12; hour < 15; hour++) {
      pushSlot(hour, 0);
      pushSlot(hour, 30);
    }
    timeSlots.push("Fim do almo√ßo");
    for (let hour = 19; hour < 23; hour++) {
      if (hour === 19) pushSlot(hour, 30);
      else if (hour < 23) {
        pushSlot(hour, 0);
        pushSlot(hour, 30);
      } else {
        pushSlot(23, 0); 
      }
    }

    const tables = ["M1", "M2", "M3", "M4", "M5", "M6", "P1", "P2", "B1", "B2", "B3", "B4", "B5", "B6"];

    const theadRow = document.querySelector('#bookingTable thead tr');
    timeSlots.forEach(time => {
      const th = document.createElement('th');
      th.textContent = time === "Fim do almo√ßo" ? "Fim do almo√ßo" : time;
      if (time === "Fim do almo√ßo") {
        th.classList.add("break");
        th.setAttribute('data-time', 'Fim do almo√ßo');
      }
      theadRow.appendChild(th);
    });

    const tbody = document.querySelector('#bookingTable tbody');
    tables.forEach(table => {
      const row = document.createElement('tr');
      row.setAttribute('data-table', table);
      const th = document.createElement('th');
      th.textContent = table;
      row.appendChild(th);
      timeSlots.forEach(time => {
        const td = document.createElement('td');
        if (time !== "Fim do almo√ßo") {
          td.setAttribute('data-time', time);
        } else {
          td.classList.add('break');
          td.setAttribute('data-time', 'Fim do almo√ßo');
        }
        row.appendChild(td);
      });
      tbody.appendChild(row);
    });

    const dateInput = document.getElementById('dateInput');
    const tableInput = document.getElementById('tableInput');
    const timeInput = document.getElementById('timeInput');
    const endTimeInput = document.getElementById('endTimeInput');

    tables.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      tableInput.appendChild(opt);
    });
    timeSlots.forEach((time, i) => {
      if (time !== "Fim do almo√ßo") {
        const opt1 = document.createElement('option');
        opt1.value = time;
        opt1.textContent = time;
        timeInput.appendChild(opt1);

        // For endTimeInput, also include the next slot even if it's "15:00"
        const nextTime = timeSlots[i + 1];
        if (nextTime !== undefined) {
          const opt2 = document.createElement('option');
          opt2.value = nextTime;
          opt2.textContent = nextTime;
          endTimeInput.appendChild(opt2);
        }
      }
    });
    endTimeInput.value = "22:30";

    async function loadBookings(date) {
      const res = await fetch(`${apiUrl}?date=${date}`);
      const data = await res.json();
      for (const table in data) {
        for (const time in data[table]) {
          const cell = document.querySelector(`tr[data-table='${table}'] td[data-time='${time}']`);
          if (!cell) continue;

          let label = data[table][time];
          let details = null;
          try {
            details = JSON.parse(label); // if it‚Äôs JSON, this succeeds
          } catch (_) { /* keep as text */ }

          if (details) {
            cell.textContent = `${details.name} (${details.people}p)`;
            cell.dataset.booking = JSON.stringify(details);
          } else {
            cell.textContent = label; // legacy
            delete cell.dataset.booking;
          }
          cell.classList.add('booked');
        }
      }
    }

    async function saveBookings(date) {
      const bookings = {};
      tables.forEach(table => {
        bookings[table] = {};
        timeSlots.forEach(time => {
          if (time !== "Fim do almo√ßo") {
            const cell = document.querySelector(`tr[data-table='${table}'] td[data-time='${time}']`);
            if (cell && (cell.dataset.booking || cell.textContent)) {
              bookings[table][time] = cell.dataset.booking || cell.textContent; // JSON or legacy text
            }
          }
        });
      });
      await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, bookings })
      });
    }

    document.getElementById('bookingForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const date = dateInput.value;
      const table = tableInput.value;
      const startTime = timeInput.value;
      const endTimeRaw = endTimeInput.value;      // may be ""
      const DEFAULT_END = "22:00";

      const name = document.getElementById('nameInput').value.trim();
      const people = document.getElementById('peopleInput').value;
      const phone = document.getElementById('phoneNumber').value.trim();
      const comments = document.getElementById('comments').value.trim();

      const displayText = `${name} (${people}p)`;
      const startIndex = timeSlots.indexOf(startTime);

      let endIndex;
      if (!endTimeRaw) {
        const defaultIdx = timeSlots.indexOf(DEFAULT_END);
        endIndex = Math.max(defaultIdx, startIndex + 1);
      } else {
        endIndex = timeSlots.indexOf(endTimeRaw);
      }

      if (startIndex === -1 || endIndex === -1 || startIndex >= endIndex) {
        alert("Intervalo inv√°lido");
        return;
      }

      const row = document.querySelector(`tr[data-table='${table}']`);

      // availability check
      for (let i = startIndex; i < endIndex; i++) {
        const cell = row.querySelector(`td[data-time='${timeSlots[i]}']`);
        if (!cell || cell.textContent !== '') {
          alert('Hor√°rio j√° reservado ou inv√°lido!');
          return;
        }
      }

      const bookingObj = { name, people: Number(people), phone, comments, table, startTime, endTime: timeSlots[endIndex] };

      // write booking to all covered cells
      for (let i = startIndex; i < endIndex; i++) {
        const cell = row.querySelector(`td[data-time='${timeSlots[i]}']`);
        if (cell) {
          cell.textContent = displayText;                     // what you see in the grid
          cell.classList.add('booked');
          cell.dataset.booking = JSON.stringify(bookingObj);  // full details stored here
        }
      }

      await saveBookings(date);
      document.getElementById('bookingForm').reset();
    });



    
    dateInput.addEventListener('change', () => {
      document.querySelectorAll('td.booked').forEach(td => {
        td.textContent = '';
        td.classList.remove('booked');
      });
      loadBookings(dateInput.value);
    });

    function updateTimeLine() {
      const table = document.getElementById('bookingTable');
      const now = new Date();
      let hours = now.getHours();
      let minutes = now.getMinutes();
      let currentTimeStr = `${hours.toString().padStart(2, '0')}:${minutes < 30 ? '00' : '30'}`;

      let index = timeSlots.indexOf(currentTimeStr);

      if (index === -1 && hours >= 15 && hours < 19) {
        index = timeSlots.indexOf("Fim do almo√ßo");
        currentTimeStr = "Fim do almo√ßo";
      }

      if (index === -1) {
        document.getElementById('timeLine').style.display = 'none';
        return;
      }

      const ths = table.querySelectorAll('thead th');
      const refCell = ths[index + 1];
      if (!refCell) return;

      const left = refCell.offsetLeft + refCell.offsetWidth / 2;
      const timeLine = document.getElementById('timeLine');
      timeLine.style.left = `${left}px`;
      timeLine.style.display = 'block';
    }

    dateInput.valueAsDate = new Date();
    loadBookings(dateInput.value);
    updateTimeLine();
    setInterval(updateTimeLine, 60000);

    // Enable booking removal by clicking on booked cells
    const modal = document.getElementById('editModal');
    const editWhen = document.getElementById('editWhen');
    const editName = document.getElementById('editName');
    const editPeople = document.getElementById('editPeople');
    const editPhone = document.getElementById('editPhone');
    const editComments = document.getElementById('editComments');
    const editSaveBtn = document.getElementById('editSaveBtn');
    const editCancelBtn = document.getElementById('editCancelBtn');
    const editDeleteBtn = document.getElementById('editDeleteBtn');

    let editingCell = null; // keep track of which cell we're editing

    function openModal() { modal.classList.remove('hidden'); }
    function closeModal() { modal.classList.add('hidden'); editingCell = null; }

    document.querySelector('#bookingTable').addEventListener('click', function (e) {
      const cell = e.target;
      if (!(cell.tagName === 'TD' && cell.classList.contains('booked'))) return;

      editingCell = cell;
      const table = cell.closest('tr').getAttribute('data-table');
      const time = cell.getAttribute('data-time');
      editWhen.textContent = `‚Äî Mesa ${table}, ${time}`;

      let d = null;
      if (cell.dataset.booking) {
        try { d = JSON.parse(cell.dataset.booking); } catch(_) {}
      }

      if (!d) {
        // legacy / text-only booking ‚Äî best effort prefill
        d = { name: cell.textContent, people: '', phone: '', comments: '', table, startTime: time, endTime: time };
      }

      editName.value = d.name || '';
      editPeople.value = d.people || '';
      editPhone.value = d.phone || '';
      editComments.value = d.comments || '';

      openModal();
    });

    // Save edits
    editSaveBtn.addEventListener('click', async () => {
      if (!editingCell) return;

      const table = editingCell.closest('tr').getAttribute('data-table');
      const time = editingCell.getAttribute('data-time');

      // keep existing timing span (start/end) if present elsewhere in the span
      let d = editingCell.dataset.booking ? JSON.parse(editingCell.dataset.booking) : {};
      d = {
        ...d,
        table,
        startTime: d.startTime || time,
        endTime: d.endTime || time,
        name: editName.value.trim(),
        people: Number(editPeople.value || 1),
        phone: editPhone.value.trim(),
        comments: editComments.value.trim()
      };

      // update ALL contiguous cells of this reservation window
      const startIdx = timeSlots.indexOf(d.startTime);
      const endIdx = Math.max(timeSlots.indexOf(d.endTime), startIdx + 1);
      const label = `${d.name} (${d.people}p)`;
      const json = JSON.stringify(d);

      const row = editingCell.closest('tr');
      for (let i = startIdx; i < endIdx; i++) {
        const c = row.querySelector(`td[data-time='${timeSlots[i]}']`);
        if (!c) continue;
        c.textContent = label;
        c.classList.add('booked');
        c.dataset.booking = json;
      }

      await saveBookings(dateInput.value);
      closeModal();
    });

    // Delete booking (clears all cells in the block)
    editDeleteBtn.addEventListener('click', async () => {
      if (!editingCell) return;
      const d = editingCell.dataset.booking ? JSON.parse(editingCell.dataset.booking) : null;
      const row = editingCell.closest('tr');

      if (d) {
        const startIdx = timeSlots.indexOf(d.startTime);
        const endIdx = Math.max(timeSlots.indexOf(d.endTime), startIdx + 1);
        for (let i = startIdx; i < endIdx; i++) {
          const c = row.querySelector(`td[data-time='${timeSlots[i]}']`);
          if (!c) continue;
          c.textContent = '';
          c.classList.remove('booked');
          delete c.dataset.booking;
        }
      } else {
        editingCell.textContent = '';
        editingCell.classList.remove('booked');
        delete editingCell.dataset.booking;
      }

      await saveBookings(dateInput.value);
      closeModal();
    });

    editCancelBtn.addEventListener('click', closeModal);
    // also close when clicking outside the card
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });  </script>
</body>
</html>
